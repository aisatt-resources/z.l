<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>商品リスト - EC商品管理システム</title>
	<link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
	<!-- ボディ情報 -->
	  <nav class="navbar">
	      <div class="navbar-content">
	          <a href="#" class="navbar-brand">EC商品管理システム</a>
	          <div class="navbar-user">
	              <span class="navbar-username">こんにちは，<span th:text="${username}">ユーザー</span></span>
	              <a th:href="@{/user/logout}" class="navbar-link">ログアウト</a>
	          </div>
	      </div>
	  </nav>
	  
	  <div class="container">
	         <div class="table-container">
	             <h2>商品管理</h2>
	             
	             <!-- 情報提示 -->
	             <div id="alertBox" class="alert"></div>
	             
	             <!-- 項目 -->
	             <div class="toolbar">
	                 <div class="search-box">
	                     <input type="text" id="searchInput" class="search-input" placeholder="商品名、IDを検索...">
	                     <button onclick="searchProducts()" class="btn btn-primary">検索</button>
	                     <button onclick="loadProducts()" class="btn btn-secondary">リセット</button>
	                 </div>
	                 <div>
	                     <a th:href="@{/product/add}" class="btn btn-success">商品追加</a>
	                 </div>
	             </div>
	             
	             <!-- 商品リスト -->
	             <table class="table">
	                 <thead>
	                     <tr>
	                         <th>ID</th>
	                         <th>商品名</th>
	                         <th>商品コード</th>
	                         <th>分類</th>
	                         <th>価格</th>
	                         <th>在庫</th>
	                         <th>ステータス</th>
	                         <th>作成時間</th>
	                         <th>操作</th>
	                     </tr>
	                 </thead>
	                 <tbody id="productTableBody">
	                     <!-- データは JavaScript 介して動的に読み込 -->
	                 </tbody>
	             </table>
	             
	             <!-- 読み込動作 -->
	             <div id="loading" class="loading">
	                 <div class="spinner"></div>
	                 <p>読み込中...</p>
	             </div>
	         </div>
	     </div>

<!--商品リスト表示ロジック処理		 			 -->
		<script>	
		// 画面を読み込時商品リスト取得
			 document.addEventListener('DOMContentLoaded', function() {
			       loadProducts();
			  });
			        
		// 商品リスト読み込
		async function loadProducts() {
			  showLoading(true);
			            
			   try {
			       const response = await fetch('/zhl/product/all');
			       const result = await response.json();
			                
			        if (result.code === 200) {
			             renderProducts(result.data);
			           } else {
			                  showAlert('商品リスト読み込み失敗1: ' + result.message, 'error');
			           }
			       } catch (error) {
			            console.error('商品リスト読み込み失敗2:', error);S
			            showAlert('ネットワークエラーです。しばらくしてからもう一度お試しください', 'error');
			      　} finally {
			           showLoading(false);
			       }
			  }
			           
		   // 商品データを画面に映す	
		    function renderProducts(products) {
		       const tbody = document.getElementById('productTableBody');
		               
		         if (!products || products.length === 0) {
		               tbody.innerHTML = '<tr><td colspan="9" class="text-center">商品データなし</td></tr>';
		              return;
		            }
		               
		           tbody.innerHTML = products.map(product => `
		                   <tr>
		                       <td>${product.id}</td>
		                       <td>${product.productName}</td>
		                       <td>${product.productCode}</td>
		                       <td>${product.category || '-'}</td>
		                       <td>¥${product.price.toFixed(2)}</td>
		                       <td>${product.stock}</td>
		                       <td>${product.status === 1 ? '<span style="color: #27ae60;">購入可能</span>' : '<span style="color: #e74c3c;">購入不可</span>'}</td>
		                       <td>${formatDateTime(product.createTime)}</td>
		                       <td>
		                           <div class="table-actions">
		                               <a href="/zhl/product/edit/${product.id}" class="btn btn-primary">更新</a>
		                               <button onclick="deleteProduct(${product.id})" class="btn btn-danger">削除</button>
		                           </div>
		                       </td>
		                   </tr>
		               `).join('');
		           }
				   
		 // 読み込みアニメーションの表示/非表示
		   function showLoading(show) {
			const loading = document.getElementById('loading');
			if (show) {
				  loading.classList.add('show');
		      } else {
				  loading.classList.remove('show');
			 }
		   }
				          
		 // 情報提示処理
		  function showAlert(message, type) {
			 const alertBox = document.getElementById('alertBox');
			  alertBox.textContent = message;
			  alertBox.className = 'alert alert-' + type + ' show';  
				 setTimeout(() => {
				     alertBox.className = 'alert';
				  }, 3000);
			}  
		 // 商品削除処理
		 async function deleteProduct(id) {
			 if (!confirm('この商品削除してもよろしいでしょうか？')) {
					return;
				   }
		     try {
				   const response = await fetch('/zhl/product/' + id, {
					method: 'DELETE'
					});
					const result = await response.json();
							                  
				    if (result.code === 200) {
						showAlert('削除成功', 'success');
						loadProducts();
						} else {
							   showAlert('削除失敗: ' + result.message, 'error');
						}
				} catch (error) {
					     console.error('商品削除失敗:', error);
						 showAlert('ネットワークエラーです。しばらくしてからもう一度お試しください', 'error');
						}
				}
		 // formatDateTimeJSON
			function formatDateTime(dateTimeStr) {
				 if (!dateTimeStr) return '-';
					const date = new Date(dateTimeStr);
					return date.toLocaleString('ja-JP', { 
					  year: 'numeric', 
					  month: '2-digit', 
					  day: '2-digit',
				      hour: '2-digit',
					  minute: '2-digit'
					});
				}

  </script>
</body>
</html>