<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<	<head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <title>新規口座作成 - 商品管理システム</title>
	    <link rel="stylesheet" th:href="@{/css/common.css}">
	</head>
	<body>
	    <div class="form-container">
	        <h1>商品管理システム</h1>
	        <h2 class="text-center">新規口座作成</h2>
	        
	        <!-- 情報提示 -->
	        <div id="alertBox" class="alert"></div>
	        
	        <!-- 新規作成フォーム -->
	        <form id="registerForm">
	            <div class="form-group">
	                <label for="username" class="form-label">ユーザー名 <span style="color: #e74c3c;">*</span></label>
	                <input type="text" id="username" name="username" class="form-input" placeholder="3-20個文字符号，文字，数字、_" required>
	                <div id="usernameError" class="form-error"></div>
	            </div>
	            
	            <div class="form-group">
	                <label for="password" class="form-label">パスワード <span style="color: #e74c3c;">*</span></label>
	                <input type="password" id="password" name="password" class="form-input" placeholder="6-20個文字符号" required>
	                <div id="passwordError" class="form-error"></div>
	            </div>
	            
	            <div class="form-group">
	                <label for="confirmPassword" class="form-label">確認パスワード <span style="color: #e74c3c;">*</span></label>
	                <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="再度パスワード入力" required>
	                <div id="confirmPasswordError" class="form-error"></div>
	            </div>
	            
	            <div class="form-group">
	                <button type="submit" class="btn btn-success btn-block">新規口座作成</button>
	            </div>
	            
	            <div class="form-group text-center">
	                <span>アカウントをお持ちの場合？</span>
	                <a th:href="@{/user/login}" class="link">ログイン</a>
	            </div>
	        </form>
		</div>
		
<!--		新規作成ロジック処理-->
		<script>
		    // 登録DTO-API送信処理
		    document.getElementById('registerForm').addEventListener('submit', async function(e) {
		        e.preventDefault();
		        
		        // クリア前にミス提示
		        clearErrors();
		        
		        // フォームのデータ取得
		        const username = document.getElementById('username').value.trim();
		        const password = document.getElementById('password').value.trim();
		        const confirmPassword = document.getElementById('confirmPassword').value.trim();
		        
		        // フフロント側からチェック
		        if (!validateForm(username, password, confirmPassword)) {
		            return;
		        }
		        
		        // 送信ボタンを無効にする
		        const submitBtn = this.querySelector('button[type="submit"]');
		        submitBtn.disabled = true;
		        submitBtn.textContent = '登録中...';
		        
		        try {
		            // 登録リクエスト送信
		            const response = await fetch('/zhl/user/register', {
		                method: 'POST',
		                headers: {
		                    'Content-Type': 'application/json'
		                },
		                body: JSON.stringify({ username, password, confirmPassword })
		            });
		            
		            const result = await response.json();
		            
		            if (result.code === 200) {
		                // 登録成功
		                showAlert('登録成功，ログイン画面へ...', 'success');
		                setTimeout(() => {
		                    window.location.href = '/zhl/user/login';
		                }, 1500);
		            } else {
		                // 登録失敗
		                showAlert(result.message || '登録失敗', 'error');
		                submitBtn.disabled = false;
		                submitBtn.textContent = '登録';
		            }
		        } catch (error) {
		            console.error('登録失敗:', error);
		            showAlert('ネットワークエラーです。しばらくしてからもう一度お試しください', 'error');
		            submitBtn.disabled = false;
		            submitBtn.textContent = '登録';
		        }
		    });
		    
		    // 新規作成登録DTO-APIチェック
		    function validateForm(username, password, confirmPassword) {
		        let isValid = true;
		        
		        // ユーザー名チェック
		        if (!username) {
		            showFieldError('username', 'ユーザー名を入力してください');
		            isValid = false;
		        } else if (username.length < 3 || username.length > 20) {
		            showFieldError('username', 'ユーザー名は3～20文字で入力してください');
		            isValid = false;
		        } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
		            showFieldError('username', 'ユーザー名には英字・数字・アンダースコアのみ使用できます');
		            isValid = false;
		        }
		        
		        // パスワードチェック
		        if (!password) {
		            showFieldError('password', 'パスワードを入力してください');
		            isValid = false;
		        } else if (password.length < 6 || password.length > 20) {
		            showFieldError('password', 'パスワードは6-20文字で入力してください');
		            isValid = false;
		        }
		        
		        // 確認パスワードチェック
		        if (!confirmPassword) {
		            showFieldError('confirmPassword', '確認パスワードを入力してください');
		            isValid = false;
		        } else if (password !== confirmPassword) {
		            showFieldError('confirmPassword', '入力したパスワードは一致しません');
		            isValid = false;
		        }
		        	        
		        return isValid;
		    }
		    
		    // メッセージプロンプトを表示
		    function showAlert(message, type) {
		        const alertBox = document.getElementById('alertBox');
		        alertBox.textContent = message;
		        alertBox.className = 'alert alert-' + type + ' show';
		        
		        // 3秒後に自動的に非表示
		        setTimeout(() => {
		            alertBox.className = 'alert';
		        }, 3000);
		    }
		    
		    // フィールドエラーの表示
		    function showFieldError(fieldName, message) {
		        const input = document.getElementById(fieldName);
		        const error = document.getElementById(fieldName + 'Error');
		        input.classList.add('error');
		        error.textContent = message;
		        error.classList.add('show');
		    }
		    
		    // すべてのエラーメッセージをクリアする
		    function clearErrors() {
		        const inputs = document.querySelectorAll('.form-input');
		        const errors = document.querySelectorAll('.form-error');
		        
		        inputs.forEach(input => input.classList.remove('error'));
		        errors.forEach(error => {
		            error.textContent = '';
		            error.classList.remove('show');
		        });
		        
		        document.getElementById('alertBox').className = 'alert';
		    }
		    
		    // 入力中にエラーメッセージを消去する
		    document.querySelectorAll('.form-input').forEach(input => {
		        input.addEventListener('input', function() {
		            this.classList.remove('error');
		            const error = document.getElementById(this.id + 'Error');
		            if (error) {
		                error.textContent = '';
		                error.classList.remove('show');
		            }
		        });
		    });
		</script>

</body>
</html>